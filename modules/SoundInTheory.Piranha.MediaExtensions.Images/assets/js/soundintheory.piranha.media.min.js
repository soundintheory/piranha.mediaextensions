piranha.media=new Vue({el:"#media",data:{loading:!0,listView:!0,currentFolder:null,currentFolderId:null,currentFolderName:null,parentFolderId:null,folders:[],filteredFolders:[],items:[],filteredItems:[],structure:[],rootCount:null,totalCount:null,canDelete:!1,isAdding:!1,newFolderName:null,filter:"",orderBy:"lastModified",direction:"desc",folder:{name:null},dropzone:null},methods:{bind:function(e){this.currentFolderId=e.currentFolderId,this.currentFolderName=e.currentFolderName,this.parentFolderId=e.parentFolderId,this.initFolders(e.structure),this.folders=e.folders,this.items=e.media.map(function(e){return e.selected=!1,e}),this.structure=e.structure,this.rootCount=e.rootCount,this.totalCount=e.totalCount,this.canDelete=e.canDelete,this.listView="list"===e.viewMode,this.sortItems()},initFolders:function(e){for(var t=0;t<e.length;t++)e[t].edit=!1,e[t].id===this.currentFolderId&&(this.currentFolder=e[t]),0<e[t].items.length&&this.initFolders(e[t].items)},editFolder:function(){this.currentFolder.edit=!0,this.$nextTick(function(){document.getElementById("folder-"+this.currentFolderId).focus()})},editAddFolder:function(){this.isAdding=!0,this.$nextTick(function(){document.getElementById("add-folder").focus()})},cancelEditFolder:function(){this.currentFolder.edit=!1,this.currentFolderName=this.currentFolder.name},drag:function(e,t){e.dataTransfer.setData("mediaId",t.id)},dragover:function(e){e.preventDefault();e=$(e.target).closest(".droppable");e.hasClass("active")||e.addClass("active")},dragleave:function(e){e.preventDefault();e=$(e.target).closest(".droppable");e.hasClass("active")&&e.removeClass("active")},drop:function(e,t){e.preventDefault();var i=$(e.target).closest(".droppable"),i=(i.hasClass("active")&&i.removeClass("active"),e.dataTransfer.getData("mediaId"));i!==t&&((e=this.items.filter(e=>e.selected).map(e=>e.id)).includes(i)||(e=[]).push(i),fetch(piranha.baseUrl+"manager/api/media/move/"+(t||""),{method:"POST",headers:piranha.utils.antiForgeryHeaders(),body:JSON.stringify(e)}).then(function(e){return e.json()}).then(function(e){"success"===e.type&&piranha.media.refresh(),400!==e.status?piranha.notifications.push(e.status):piranha.notifications.unauthorized()}).catch(function(e){console.log("error:",e)}))},onItemClick:function(e,t){e.shiftKey?t.selected=!t.selected:piranha.preview.openItem(t)},showList:function(){this.listView=!0},showGallery:function(){this.listView=!1},load:function(e,t){var i=this;t||history.pushState({folderId:e},"",piranha.baseUrl+"manager/media"+(e?"/"+e:"")),fetch(piranha.baseUrl+"manager/api/mediamanager/list"+(e?"/"+e:"")+"/?width=210&height=160").then(function(e){return e.json()}).then(function(e){i.bind(e),document.title=e.currentFolderName||"Media"}).catch(function(e){console.log("error:",e)})},getThumbnailUrl:function(e){return null!==e.altVersionUrl?e.altVersionUrl:piranha.baseUrl+"manager/api/media/url/"+e.id+"/210/160"},refresh:function(){piranha.media.load(piranha.media.currentFolderId)},addFolder:function(){this.saveFolder(null,null,{parentId:this.currentFolderId,name:this.folder.name}),this.isAdding=!1},updateFolder:function(){this.saveFolder(null,null,{id:this.currentFolderId,name:this.currentFolderName})},saveFolder:function(t,e,i){var n=this;if(null!=e&&!1===(e=document.getElementById(e)).checkValidity())return void e.classList.add("was-validated");fetch(piranha.baseUrl+"manager/api/media/folder/save",{method:"post",headers:piranha.utils.antiForgeryHeaders(),body:JSON.stringify(i)}).then(function(e){return e.json()}).then(function(e){"success"===e.status.type&&(null!=t&&$(t).modal("hide"),n.folder.name=null,n.items=e.media,n.refresh()),400!==e.status?piranha.notifications.push(e.status):piranha.notifications.unauthorized()}).catch(function(e){console.log("error:",e)})},remove:function(e){var t=this;piranha.alert.open({title:piranha.resources.texts.delete,body:piranha.resources.texts.deleteMediaSelectionConfirm,confirmCss:"btn-danger",confirmIcon:"fas fa-trash",confirmText:piranha.resources.texts.delete,onConfirm:function(){fetch(piranha.baseUrl+"manager/api/media/delete",{method:"delete",headers:piranha.utils.antiForgeryHeaders(),body:JSON.stringify([e])}).then(function(e){return e.json()}).then(function(e){t.refresh(),400!==e.status?piranha.notifications.push(e):piranha.notifications.unauthorized()}).catch(function(e){console.log("error:",e)})}})},removeSelection:function(){var t=this,e=this.items.filter(e=>e.selected).map(e=>e.id);piranha.alert.open({title:piranha.resources.texts.delete,body:piranha.resources.texts.deleteMediaSelectionConfirm,confirmCss:"btn-danger",confirmIcon:"fas fa-trash",confirmText:piranha.resources.texts.delete,onConfirm:function(){fetch(piranha.baseUrl+"manager/api/media/delete",{method:"delete",headers:piranha.utils.antiForgeryHeaders(),body:JSON.stringify(e)}).then(function(e){return e.json()}).then(function(e){t.refresh(),400!==e.status?piranha.notifications.push(e.status):piranha.notifications.unauthorized()}).catch(function(e){console.log("error:",e)})}})},removeFolder:function(t){var i=this;piranha.alert.open({title:piranha.resources.texts.delete,body:piranha.resources.texts.deleteMediaSelectionConfirm,confirmCss:"btn-danger",confirmIcon:"fas fa-trash",confirmText:piranha.resources.texts.delete,onConfirm:function(){fetch(piranha.baseUrl+"manager/api/media/folder/delete",{method:"delete",headers:piranha.utils.antiForgeryHeaders(),body:JSON.stringify(t)}).then(function(e){return e.json()}).then(function(e){i.bind(e),history.pushState({folderId:t},"",piranha.baseUrl+"manager/media"+(t?"/"+t:"")),document.title=e.currentFolderName||"Media",400!==e.status?piranha.notifications.push(e.status):piranha.notifications.unauthorized()}).catch(function(e){console.log("error:",e)})}})},toggleDir:function(){"asc"==this.direction?this.direction="desc":this.direction="asc",this.sortItems()},sortItems:function(){var e=[...this.items],t=[...this.folders];const i="name";"asc"==this.direction?(e.sort((e,t)=>e[this.orderBy].localeCompare(t[this.orderBy])),t.sort((e,t)=>e[i].localeCompare(t[i]))):(e.sort((e,t)=>t[this.orderBy].localeCompare(e[this.orderBy])),t.sort((e,t)=>t[i].localeCompare(e[i]))),this.items=e,this.filteredItems=[...e.filter(e=>""===this.filter||e.filename.toLowerCase().includes(this.filter.toLowerCase()))],this.filteredFolders=[...t.filter(e=>""===this.filter||e.name.toLowerCase().includes(this.filter.toLowerCase()))]},filterItems:function(){this.filteredItems=[...this.items.filter(e=>""===this.filter||e.filename.toLowerCase().includes(this.filter.toLowerCase()))],this.filteredFolders=[...this.folders.filter(e=>""===this.filter||e.name.toLowerCase().includes(this.filter.toLowerCase()))]}},computed:{hasSelection:function(){return this.items.some(function(e){return e.selected})}},watch:{orderBy:function(e){this.sortItems(),this.filterItems()},filter:function(e){this.filterItems()},direction:function(e){this.sortItems()}},updated:function(){this.loading&&(piranha.permissions.media.add&&(this.dropzone=piranha.dropzone.init("#media-upload-container",{uploadMultiple:!1}),this.dropzone.on("complete",function(e){"success"===e.status&&setTimeout(function(){piranha.media.dropzone.removeFile(e)},3e3)}),this.dropzone.on("queuecomplete",function(){piranha.media.refresh()})),this.loading=!1)},mounted:function(){var t=this;window.onpopstate=function(e){t.load(e.state&&e.state.folderId?e.state.folderId:"",!0)}}}),$(document).on("shown.bs.modal","#mediaFolderModal",function(e){$("#mediaFolderName").focus()}),Vue.component("folder-item",{props:["item","selected"],template:'\n<li class="dd-item expanded" :class="{ active: item.id === selected, expanded: item.isExpanded || item.items.length === 0 }" :data-id="item.id">\n    <a v-if="!item.edit" class="droppable" v-on:click.prevent="piranha.media.load(item.id)" href="#" draggable="true" v-on:dragstart="piranha.media.drag($event, item)" v-on:dragover="piranha.media.dragover" v-on:dragleave="piranha.media.dragleave" v-on:drop="piranha.media.drop($event, item.id)">\n        <i class="fas fa-folder"></i>{{ item.name }}\n        <span class="badge badge-light float-right">{{ item.mediaCount }}</span>\n    </a>\n    <form v-else v-on:submit.prevent="piranha.media.updateFolder()" class="d-flex">\n        <i class="fas fa-folder"></i>\n        <input :id="\'folder-\' + item.id" type="text" v-on:keyup.esc="piranha.media.cancelEditFolder()" v-model="piranha.media.currentFolderName" class="form-control form-control-sm">\n    </form>\n    <ol v-if="selected === item.id && piranha.media.isAdding" class="dd-list">\n        <form v-on:submit.prevent="piranha.media.addFolder()" class="d-flex">\n            <i class="fas fa-folder"></i><input id="add-folder" type="text" v-on:keyup.esc="piranha.media.isAdding = false" v-model="piranha.media.folder.name" class="form-control form-control-sm">\n        </form>\n    </ol>\n    <ol v-if="item.items.length > 0" class="dd-list">\n        <folder-item v-for="child in item.items" v-bind:key="child.id" v-bind:selected="selected" v-bind:item="child"></folder-item>\n    </ol>\n</li>\n'});